version: '3'

vars:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'

  MODULES: assembly inventory order payment platform iam notification

  # –ü—É—Ç–∏ (—Ä–∞–∑–Ω—ã–µ –¥–ª—è shell)
  BIN_DIR:
    sh: echo "{{.ROOT_DIR}}/bin"
    powershell: echo "{{.ROOT_DIR}}\bin"

  GOLANGCI_LINT:
    sh: echo "{{.BIN_DIR}}/golangci-lint"
    powershell: echo "{{.BIN_DIR}}\golangci-lint.exe"

  GCI:
    sh: echo "{{.BIN_DIR}}/gci"
    powershell: echo "{{.BIN_DIR}}\gci.exe"

  GOFUMPT:
    sh: echo "{{.BIN_DIR}}/gofumpt"
    powershell: echo "{{.BIN_DIR}}\gofumpt.exe"

tasks:

  # ---------------- FORMATTERS ----------------

  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç gofumpt –∏ gci (Windows + Linux)"
    cmds:
      - sh: |
          set -e
          mkdir -p {{.BIN_DIR}}

          if [ ! -f "{{.GOFUMPT}}" ]; then
            echo "üì¶ Installing gofumpt {{.GOFUMPT_VERSION}}"
            GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
          fi

          if [ ! -f "{{.GCI}}" ]; then
            echo "üì¶ Installing gci {{.GCI_VERSION}}"
            GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
          fi

      - powershell: |
          New-Item -ItemType Directory -Force "{{.BIN_DIR}}" | Out-Null

          if (!(Test-Path "{{.GOFUMPT}}")) {
            Write-Host "üì¶ Installing gofumpt {{.GOFUMPT_VERSION}}"
            $env:GOBIN="{{.BIN_DIR}}"
            go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
          }

          if (!(Test-Path "{{.GCI}}")) {
            Write-Host "üì¶ Installing gci {{.GCI_VERSION}}"
            $env:GOBIN="{{.BIN_DIR}}"
            go install github.com/daixiang0/gci@{{.GCI_VERSION}}
          }

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    deps: [ install-formatters ]
    cmds:
      - sh: |
          set -e
          for module in {{.MODULES}}; do
            if [ -d "$module" ]; then
              echo "üßº Formatting $module"
              find "$module" -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
              find "$module" -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write \
                -s standard \
                -s default \
                -s "prefix(github.com/olezhek28/microservices-course-olezhek-solution)" {} +
            fi
          done

      - powershell: |
          $modules = "{{.MODULES}}".Split(" ")
          foreach ($module in $modules) {
            if (Test-Path $module) {
              Write-Host "üßº Formatting $module"

              Get-ChildItem $module -Recurse -Filter *.go |
                Where-Object { $_.FullName -notmatch '\\mocks\\' } |
                ForEach-Object {
                  & "{{.GOFUMPT}}" -extra -w $_.FullName
                  & "{{.GCI}}" write `
                    -s standard `
                    -s default `
                    -s "prefix(github.com/olezhek28/microservices-course-olezhek-solution)" `
                    $_.FullName
                }
            }
          }

  # ---------------- LINT ----------------

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint"
    cmds:
      - sh: |
          set -e
          mkdir -p {{.BIN_DIR}}

          if [ ! -f "{{.GOLANGCI_LINT}}" ]; then
            echo "üì¶ Installing golangci-lint {{.GOLANGCI_LINT_VERSION}}"
            GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
          fi

      - powershell: |
          New-Item -ItemType Directory -Force "{{.BIN_DIR}}" | Out-Null

          if (!(Test-Path "{{.GOLANGCI_LINT}}")) {
            Write-Host "üì¶ Installing golangci-lint {{.GOLANGCI_LINT_VERSION}}"
            $env:GOBIN="{{.BIN_DIR}}"
            go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
          }

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    deps: [ install-golangci-lint ]
    cmds:
      - sh: |
          set -e
          for module in {{.MODULES}}; do
            if [ -d "$module" ]; then
              echo "üîç Linting $module"
              {{.GOLANGCI_LINT}} run "$module/..." --config=.golangci.yml
            fi
          done

      - powershell: |
          $ErrorActionPreference = "Stop"
          $modules = "{{.MODULES}}".Split(" ")

          foreach ($module in $modules) {
            if (Test-Path $module) {
              Write-Host "üîç Linting $module"
              & "{{.GOLANGCI_LINT}}" run "$module/..." --config=.golangci.yml
            }
          }
