version: '3'

vars:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'

  BIN_DIR: '{{.ROOT_DIR}}\bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}\golangci-lint.exe'
  GCI: '{{.BIN_DIR}}\gci.exe'
  GOFUMPT: '{{.BIN_DIR}}\gofumpt.exe'

  MODULES: assembly inventory order payment platform iam notification

tasks:
  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin (Windows)"
    cmds:
      - powershell -Command |
        if (!(Test-Path "{{.BIN_DIR}}")) {
        New-Item -ItemType Directory -Path "{{.BIN_DIR}}" | Out-Null
        }
        
        if (!(Test-Path "{{.GOFUMPT}}")) {
        Write-Host "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}..."
        $env:GOBIN="{{.BIN_DIR}}"
        go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        
        if (!(Test-Path "{{.GCI}}")) {
        Write-Host "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}..."
        $env:GOBIN="{{.BIN_DIR}}"
        go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–µ–∫—Ç gofumpt + gci (Windows)"
    deps: [ install-formatters ]
    cmds:
      - powershell -Command |
        Write-Host "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        
        $modules = "{{.MODULES}}".Split(" ")
        foreach ($module in $modules) {
        if (Test-Path $module) {
        Write-Host "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º $module"
        Get-ChildItem $module -Recurse -Filter *.go |
        Where-Object { $_.FullName -notmatch '\\mocks\\' } |
        ForEach-Object {
        & "{{.GOFUMPT}}" -extra -w $_.FullName
        }
        }
        }

      - powershell -Command |
        Write-Host "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."
        
        $modules = "{{.MODULES}}".Split(" ")
        foreach ($module in $modules) {
        if (Test-Path $module) {
        Write-Host "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ $module"
        Get-ChildItem $module -Recurse -Filter *.go |
        Where-Object { $_.FullName -notmatch '\\mocks\\' } |
        ForEach-Object {
        & "{{.GCI}}" write `
        -s standard `
        -s default `
        -s "prefix(github.com/olezhek28/microservices-course-olezhek-solution)" `
        $_.FullName
        }
        }
        }

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ ./bin (Windows)"
    cmds:
      - powershell -Command |
        if (!(Test-Path "{{.BIN_DIR}}")) {
        New-Item -ItemType Directory -Path "{{.BIN_DIR}}" | Out-Null
        }
        
        if (!(Test-Path "{{.GOLANGCI_LINT}}")) {
        Write-Host "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
        $env:GOBIN="{{.BIN_DIR}}"
        go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π (Windows)"
    deps: [ install-golangci-lint ]
    cmds:
      - powershell -Command |
        $ErrorActionPreference = "Stop"
        $modules = "{{.MODULES}}".Split(" ")
        $err = 0
        
        Write-Host "üîç –õ–∏–Ω—Ç–∏–º –≤—Å–µ –º–æ–¥—É–ª–∏ ..."
        
        foreach ($module in $modules) {
        if (Test-Path $module) {
        Write-Host "üîç –õ–∏–Ω—Ç–∏–º $module"
        try {
        & "{{.GOLANGCI_LINT}}" run "$module/..." --config=.golangci.yml
        } catch {
        $err = 1
        }
        }
        }
        
        exit $err
